{"ast":null,"code":"import _objectSpread from\"/home/runner/work/galadmin/galadmin/src/front/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import _regeneratorRuntime from\"/home/runner/work/galadmin/galadmin/src/front/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";import _asyncToGenerator from\"/home/runner/work/galadmin/galadmin/src/front/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"/home/runner/work/galadmin/galadmin/src/front/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _createForOfIteratorHelper from\"/home/runner/work/galadmin/galadmin/src/front/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper.js\";import{useContext,useRef,useState}from\"react\";import{useParams,useHistory}from\"react-router-dom\";import axios from\"axios\";import Input from\"../components/Input\";import LabelTooltip from\"../components/LabelTooltip\";import{ConfigContext}from'../contexts/ConfigContext';import checkRequiredColumns from\"../utils/checkRequiredColumns\";import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";export default(function(){var config=useContext(ConfigContext);var _useParams=useParams(),viewIndex=_useParams.viewIndex,panelIndex=_useParams.panelIndex,recordId=_useParams.recordId;var history=useHistory();var view=config.views[viewIndex];var panel=panelIndex?view.recordViewPanels[panelIndex]:null;var filteredColumns=panel?panel.createConfig.columns:view.columns.filter(function(column){return column.dataType&&(column.canEditOnCreation===true||column.canEdit!==false)&&!column.hidden;});var initialData={};var _iterator=_createForOfIteratorHelper(filteredColumns),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var column=_step.value;if(column.defaultOption){initialData[column.name]=column.defaultOption;}else if(column.dataType===\"tinyint\"){initialData[column.name]=column.optional?\"NULL\":\"0\";}else if(column.dataType===\"select\"&&column.optional){initialData[column.name]=\"NULL\";}else if(column.dataType===\"select\"&&Array.isArray(column.options)){initialData[column.name]=column.options[0];}else if(column.dataType===\"select\"){initialData[column.name]=Object.keys(column.options)[0];}if(column.defaultValue){initialData[column.name]=column.defaultValue;}}}catch(err){_iterator.e(err);}finally{_iterator.f();}var data=useRef(initialData);var _useState=useState(false),_useState2=_slicedToArray(_useState,2),isCreating=_useState2[0],setIsCreating=_useState2[1];var createRecord=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(){var key,_view$createConfig,response;return _regeneratorRuntime().wrap(function _callee$(_context){while(1)switch(_context.prev=_context.next){case 0:if(checkRequiredColumns(filteredColumns,data.current)){_context.next=2;break;}return _context.abrupt(\"return\");case 2:for(key in view.createFilters){data.current[key]=view.createFilters[key];}setIsCreating(true);_context.prev=4;_context.next=7;return axios.post(\"/createRecord\",{viewIndex:viewIndex,panelIndex:panelIndex,recordId:recordId,data:data.current});case 7:response=_context.sent;setIsCreating(false);if(recordId){// Create from panel view\nhistory.push(\"/record/\".concat(viewIndex,\"/\").concat(recordId));}else if(view!==null&&view!==void 0&&(_view$createConfig=view.createConfig)!==null&&_view$createConfig!==void 0&&_view$createConfig.redirectToCreatedItems){history.push(\"/record/\".concat(viewIndex,\"/\").concat(response.data.id));}else{history.push(\"/records/\".concat(viewIndex));}_context.next=16;break;case 12:_context.prev=12;_context.t0=_context[\"catch\"](4);window.swal({title:\"Erreur\",text:axios.isAxiosError(_context.t0)?_context.t0.response.data.message:\"Une erreur est survenue\",dangerMode:true});setIsCreating(false);case 16:case\"end\":return _context.stop();}},_callee,null,[[4,12]]);}));return function createRecord(){return _ref.apply(this,arguments);};}();return/*#__PURE__*/_jsxs(\"div\",{class:\"view\",children:[/*#__PURE__*/_jsx(\"div\",{class:\"viewHeader\",children:/*#__PURE__*/_jsx(\"div\",{class:\"viewTitle\",children:panel?panel.createConfig.label:\"Cr\\xE9er \".concat(view.aNewSingular)})}),/*#__PURE__*/_jsxs(\"div\",{class:\"paddedView\",children:[/*#__PURE__*/_jsx(\"div\",{class:\"form\",children:filteredColumns.map(function(column,index){return/*#__PURE__*/_jsxs(\"div\",{class:\"formElement\",children:[/*#__PURE__*/_jsxs(\"div\",{class:\"formLabel\",children:[column.label,\" \",column.required?\"*\":\"\",column.labelTooltip?/*#__PURE__*/_jsx(LabelTooltip,{text:column.labelTooltip}):null]}),/*#__PURE__*/_jsx(\"div\",{class:\"formInput\",children:/*#__PURE__*/_jsx(Input,{column:column,onChange:function onChange(newValues){data.current=_objectSpread(_objectSpread({},data.current),newValues);}})})]},index);})}),/*#__PURE__*/_jsx(\"div\",{class:\"button greenButton \".concat(isCreating?\"loading\":\"\"),onClick:createRecord,children:isCreating?\"Sauvegarde en cours...\":\"Créer\"}),/*#__PURE__*/_jsx(\"div\",{class:\"button\",onClick:function onClick(){return history.goBack();},children:\"Annuler\"})]})]});});","map":{"version":3,"names":["useContext","useRef","useState","useParams","useHistory","axios","Input","LabelTooltip","ConfigContext","checkRequiredColumns","jsx","_jsx","jsxs","_jsxs","config","_useParams","viewIndex","panelIndex","recordId","history","view","views","panel","recordViewPanels","filteredColumns","createConfig","columns","filter","column","dataType","canEditOnCreation","canEdit","hidden","initialData","_iterator","_createForOfIteratorHelper","_step","s","n","done","value","defaultOption","name","optional","Array","isArray","options","Object","keys","defaultValue","err","e","f","data","_useState","_useState2","_slicedToArray","isCreating","setIsCreating","createRecord","_ref","_asyncToGenerator","_regeneratorRuntime","mark","_callee","key","_view$createConfig","response","wrap","_callee$","_context","prev","next","current","abrupt","createFilters","post","sent","push","concat","redirectToCreatedItems","id","t0","window","swal","title","text","isAxiosError","message","dangerMode","stop","apply","arguments","class","children","label","aNewSingular","map","index","required","labelTooltip","onChange","newValues","_objectSpread","onClick","goBack"],"sources":["/home/runner/work/galadmin/galadmin/src/front/src/pages/CreateRecord.js"],"sourcesContent":["import { useContext, useRef, useState } from \"react\";\nimport {\n    useParams,\n    useHistory\n} from \"react-router-dom\";\nimport axios from \"axios\";\nimport Input from \"../components/Input\"\nimport LabelTooltip from \"../components/LabelTooltip\"\nimport { ConfigContext } from '../contexts/ConfigContext'\nimport checkRequiredColumns from \"../utils/checkRequiredColumns\";\n\nexport default () => {\n    const config = useContext(ConfigContext)\n    const { viewIndex, panelIndex, recordId } = useParams();\n    const history = useHistory();\n    const view = config.views[viewIndex];\n    const panel = panelIndex ? view.recordViewPanels[panelIndex] : null;\n    const filteredColumns = panel ? panel.createConfig.columns : view.columns.filter(\n        column => column.dataType &&\n            (column.canEditOnCreation === true || column.canEdit !== false)\n            && !column.hidden\n    )\n\n    const initialData = {}\n    for (const column of filteredColumns) {\n        if (column.defaultOption) {\n            initialData[column.name] = column.defaultOption\n        } else if (column.dataType === \"tinyint\") {\n            initialData[column.name] = column.optional ? \"NULL\" : \"0\"\n        } else if (column.dataType === \"select\" && column.optional) {\n            initialData[column.name] = \"NULL\"\n        } else if (column.dataType === \"select\" && Array.isArray(column.options)) {\n            initialData[column.name] = column.options[0]\n        } else if (column.dataType === \"select\") {\n            initialData[column.name] = Object.keys(column.options)[0]\n        }\n        if (column.defaultValue) {\n            initialData[column.name] = column.defaultValue\n        }\n    }\n    const data = useRef(initialData)\n    const [isCreating, setIsCreating] = useState(false)\n\n    const createRecord = async () => {\n        if (!checkRequiredColumns(filteredColumns, data.current)) return;\n        for (const key in view.createFilters) {\n            data.current[key] = view.createFilters[key]\n        }\n        setIsCreating(true)\n        try {\n            const response = await axios.post(\"/createRecord\", {\n                viewIndex,\n                panelIndex,\n                recordId,\n                data: data.current\n            })\n            setIsCreating(false)\n            if (recordId) { // Create from panel view\n                history.push(`/record/${viewIndex}/${recordId}`)\n            } else if (view?.createConfig?.redirectToCreatedItems) {\n                history.push(`/record/${viewIndex}/${response.data.id}`)\n            } else {\n                history.push(`/records/${viewIndex}`)\n            }\n        } catch (error) {\n            window.swal({\n                title: \"Erreur\",\n                text: axios.isAxiosError(error) ? error.response.data.message : \"Une erreur est survenue\",\n                dangerMode: true\n            })\n            setIsCreating(false)\n        }\n    }\n\n    return (\n        <div class=\"view\">\n            <div class=\"viewHeader\">\n                <div class=\"viewTitle\">{panel ? panel.createConfig.label : `Créer ${view.aNewSingular}`}</div>\n            </div>\n            <div class=\"paddedView\">\n                <div class=\"form\">\n                    {filteredColumns.map((column, index) => {\n                        return (\n                            <div class='formElement' key={index}>\n                                <div class='formLabel'>\n                                    {column.label} {column.required ? \"*\" : \"\"}\n                                    {column.labelTooltip ? <LabelTooltip text={column.labelTooltip} /> : null}\n                                </div>\n                                <div class='formInput'>\n                                    <Input\n                                        column={column}\n                                        onChange={(newValues) => { data.current = { ...data.current, ...newValues } }}\n                                    />\n                                </div>\n                            </div>\n                        )\n                    })}\n                </div>\n                <div class={`button greenButton ${isCreating ? \"loading\" : \"\"}`} onClick={createRecord}>{isCreating ? \"Sauvegarde en cours...\" : \"Créer\"}</div>\n                <div class=\"button\" onClick={() => history.goBack()}>Annuler</div>\n            </div>\n        </div>\n    )\n}"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}